{
  "title": "Unified Storage Architecture Implementation",
  "version": "1.0.0",
  "description": "Product requirements for refactoring MDK's storage layer to have a single unified implementation that implements both OpenMLS's StorageProvider<1> trait and MDK's storage traits, enabling atomic transactions across MLS and MDK state for proper commit race resolution.",
  "created": "2026-01-13",
  "related_issues": [
    {
      "id": 54,
      "title": "No Deterministic Commit Race Resolution",
      "url": "https://github.com/marmot-protocol/mdk/issues/54"
    },
    {
      "id": 25,
      "title": "Handle out of order Commit messages better",
      "url": "https://github.com/marmot-protocol/mdk/issues/25"
    }
  ],
  "phases": [
    {
      "id": "phase-1",
      "name": "Update mdk-storage-traits",
      "description": "Remove the openmls_storage() accessor pattern and make MdkStorageProvider require StorageProvider<1> directly.",
      "status": "pending",
      "requirements": [
        {
          "id": "REQ-1.1",
          "title": "Create MdkStorageError Enum",
          "description": "Create a new error type for MDK storage operations to be used as the associated Error type for OpenMLS StorageProvider trait.",
          "status": "pending",
          "acceptance_criteria": [
            "New file crates/mdk-storage-traits/src/error.rs exists",
            "MdkStorageError enum has variants: Database, Serialization, Deserialization, NotFound, Other",
            "All variants include descriptive String payload",
            "Enum implements Debug, Error (thiserror)",
            "Error type is re-exported from crate root"
          ],
          "deliverables": [
            "crates/mdk-storage-traits/src/error.rs"
          ]
        },
        {
          "id": "REQ-1.2",
          "title": "Update MdkStorageProvider Trait",
          "description": "Modify the MdkStorageProvider trait to directly require StorageProvider<1> instead of the accessor pattern.",
          "status": "pending",
          "acceptance_criteria": [
            "MdkStorageProvider trait removes type OpenMlsStorageProvider associated type",
            "MdkStorageProvider trait removes openmls_storage() method",
            "MdkStorageProvider trait removes openmls_storage_mut() method",
            "MdkStorageProvider trait adds StorageProvider<CURRENT_VERSION> as a supertrait",
            "MdkStorageProvider trait adds fn backend(&self) -> Backend method",
            "CURRENT_VERSION constant is defined (value: 1)",
            "Crate compiles successfully (cargo check -p mdk-storage-traits)"
          ],
          "deliverables": [
            "Updated crates/mdk-storage-traits/src/lib.rs"
          ]
        },
        {
          "id": "REQ-1.3",
          "title": "Add openmls_traits Dependency",
          "description": "Add openmls_traits as a dependency to mdk-storage-traits for the StorageProvider trait.",
          "status": "pending",
          "acceptance_criteria": [
            "openmls_traits = \"0.4.1\" added to mdk-storage-traits/Cargo.toml",
            "StorageProvider trait is imported and usable",
            "No version conflicts with workspace"
          ],
          "deliverables": [
            "Updated crates/mdk-storage-traits/Cargo.toml"
          ]
        }
      ]
    },
    {
      "id": "phase-2",
      "name": "Implement StorageProvider<1> for MdkSqliteStorage",
      "description": "Make MdkSqliteStorage directly implement the OpenMLS storage trait with a single unified connection.",
      "status": "pending",
      "requirements": [
        {
          "id": "REQ-2.1",
          "title": "Remove openmls_sqlite_storage Dependency",
          "description": "Remove the external OpenMLS SQLite storage dependency as we will implement the trait ourselves.",
          "status": "pending",
          "acceptance_criteria": [
            "openmls_sqlite_storage removed from mdk-sqlite-storage/Cargo.toml",
            "openmls_sqlite_storage removed from workspace Cargo.toml if present",
            "No compilation errors after removal (may need to comment out code temporarily)"
          ],
          "deliverables": [
            "Updated crates/mdk-sqlite-storage/Cargo.toml"
          ]
        },
        {
          "id": "REQ-2.2",
          "title": "Create JSON Codec Module",
          "description": "Implement a JSON codec for serializing/deserializing OpenMLS types to SQLite blobs.",
          "status": "pending",
          "acceptance_criteria": [
            "New file crates/mdk-sqlite-storage/src/mls_storage/codec.rs exists",
            "JsonCodec struct implemented with serialize<T: Serialize>() method",
            "JsonCodec struct implemented with deserialize<T: DeserializeOwned>() method",
            "Both methods return Result<_, MdkStorageError>",
            "Unit tests verify round-trip serialization works"
          ],
          "deliverables": [
            "crates/mdk-sqlite-storage/src/mls_storage/codec.rs"
          ]
        },
        {
          "id": "REQ-2.3",
          "title": "Update MdkSqliteStorage Struct",
          "description": "Refactor MdkSqliteStorage to use a single unified connection instead of dual connections.",
          "status": "pending",
          "acceptance_criteria": [
            "MdkSqliteStorage struct has single connection field: Arc<tokio::sync::Mutex<Connection>>",
            "Removed openmls_storage field",
            "Removed db_connection field (consolidated into connection)",
            "Constructor updated to create single connection",
            "tokio dependency added with sync feature"
          ],
          "deliverables": [
            "Updated crates/mdk-sqlite-storage/src/lib.rs"
          ]
        },
        {
          "id": "REQ-2.4",
          "title": "Create Fresh Migration V001",
          "description": "Create a single initial migration that creates all tables (both MLS and MDK) in a unified schema.",
          "status": "pending",
          "acceptance_criteria": [
            "Old migration files removed (V100__*.sql, V10*__*.sql)",
            "New file migrations/V001__initial_schema.sql exists",
            "Migration creates all 8 OpenMLS tables (openmls_group_data, openmls_proposals, openmls_own_leaf_nodes, openmls_key_packages, openmls_psks, openmls_signature_keys, openmls_encryption_keys, openmls_epoch_key_pairs)",
            "Migration creates all 7 MDK tables (groups, group_relays, group_exporter_secrets, messages, processed_messages, welcomes, processed_welcomes)",
            "All indexes created as specified in plan",
            "Foreign key constraints included"
          ],
          "deliverables": [
            "crates/mdk-sqlite-storage/migrations/V001__initial_schema.sql"
          ]
        },
        {
          "id": "REQ-2.5",
          "title": "Implement StorageProvider Write Methods",
          "description": "Implement all 18 write methods required by StorageProvider<1> trait.",
          "status": "pending",
          "acceptance_criteria": [
            "write_mls_join_config implemented and tested",
            "append_own_leaf_node implemented and tested",
            "queue_proposal implemented and tested",
            "write_tree implemented and tested",
            "write_interim_transcript_hash implemented and tested",
            "write_context implemented and tested",
            "write_confirmation_tag implemented and tested",
            "write_group_state implemented and tested",
            "write_message_secrets implemented and tested",
            "write_resumption_psk_store implemented and tested",
            "write_own_leaf_index implemented and tested",
            "write_group_epoch_secrets implemented and tested",
            "write_application_export_tree implemented (feature-gated)",
            "write_signature_key_pair implemented and tested",
            "write_encryption_key_pair implemented and tested",
            "write_encryption_epoch_key_pairs implemented and tested",
            "write_key_package implemented and tested",
            "write_psk implemented and tested"
          ],
          "deliverables": [
            "crates/mdk-sqlite-storage/src/mls_storage/mod.rs",
            "crates/mdk-sqlite-storage/src/mls_storage/group_data.rs",
            "crates/mdk-sqlite-storage/src/mls_storage/proposals.rs",
            "crates/mdk-sqlite-storage/src/mls_storage/key_packages.rs",
            "crates/mdk-sqlite-storage/src/mls_storage/signature_keys.rs",
            "crates/mdk-sqlite-storage/src/mls_storage/encryption_keys.rs",
            "crates/mdk-sqlite-storage/src/mls_storage/epoch_key_pairs.rs",
            "crates/mdk-sqlite-storage/src/mls_storage/own_leaf_nodes.rs",
            "crates/mdk-sqlite-storage/src/mls_storage/psks.rs"
          ]
        },
        {
          "id": "REQ-2.6",
          "title": "Implement StorageProvider Read Methods",
          "description": "Implement all 19 read methods required by StorageProvider<1> trait.",
          "status": "pending",
          "acceptance_criteria": [
            "mls_group_join_config implemented and tested",
            "own_leaf_nodes implemented and tested",
            "queued_proposal_refs implemented and tested",
            "queued_proposals implemented and tested",
            "tree implemented and tested",
            "group_context implemented and tested",
            "interim_transcript_hash implemented and tested",
            "confirmation_tag implemented and tested",
            "group_state implemented and tested",
            "message_secrets implemented and tested",
            "resumption_psk_store implemented and tested",
            "own_leaf_index implemented and tested",
            "group_epoch_secrets implemented and tested",
            "signature_key_pair implemented and tested",
            "encryption_key_pair implemented and tested",
            "encryption_epoch_key_pairs implemented and tested",
            "key_package implemented and tested",
            "psk implemented and tested",
            "application_export_tree implemented (feature-gated)"
          ],
          "deliverables": [
            "Read method implementations in mls_storage module files"
          ]
        },
        {
          "id": "REQ-2.7",
          "title": "Implement StorageProvider Delete Methods",
          "description": "Implement all 19 delete methods required by StorageProvider<1> trait.",
          "status": "pending",
          "acceptance_criteria": [
            "remove_proposal implemented and tested",
            "delete_own_leaf_nodes implemented and tested",
            "delete_group_config implemented and tested",
            "delete_tree implemented and tested",
            "delete_confirmation_tag implemented and tested",
            "delete_group_state implemented and tested",
            "delete_context implemented and tested",
            "delete_interim_transcript_hash implemented and tested",
            "delete_message_secrets implemented and tested",
            "delete_all_resumption_psk_secrets implemented and tested",
            "delete_own_leaf_index implemented and tested",
            "delete_group_epoch_secrets implemented and tested",
            "clear_proposal_queue implemented and tested",
            "delete_signature_key_pair implemented and tested",
            "delete_encryption_key_pair implemented and tested",
            "delete_encryption_epoch_key_pairs implemented and tested",
            "delete_key_package implemented and tested",
            "delete_psk implemented and tested",
            "delete_application_export_tree implemented (feature-gated)"
          ],
          "deliverables": [
            "Delete method implementations in mls_storage module files"
          ]
        },
        {
          "id": "REQ-2.8",
          "title": "Implement Transaction/Savepoint Support",
          "description": "Add savepoint-based transaction support for atomic operations and rollback capability.",
          "status": "pending",
          "acceptance_criteria": [
            "savepoint(name: &str) method implemented",
            "release_savepoint(name: &str) method implemented",
            "rollback_to_savepoint(name: &str) method implemented",
            "Methods return Result<(), Error>",
            "Integration test demonstrates savepoint/rollback workflow",
            "Nested savepoints work correctly"
          ],
          "deliverables": [
            "Transaction methods in crates/mdk-sqlite-storage/src/lib.rs"
          ]
        },
        {
          "id": "REQ-2.9",
          "title": "Update Existing MDK Storage Implementations",
          "description": "Ensure GroupStorage, MessageStorage, and WelcomeStorage implementations work with the new single-connection architecture.",
          "status": "pending",
          "acceptance_criteria": [
            "GroupStorage impl updated to use unified connection",
            "MessageStorage impl updated to use unified connection",
            "WelcomeStorage impl updated to use unified connection",
            "All existing MDK storage tests pass",
            "No duplicate connection locking issues"
          ],
          "deliverables": [
            "Updated storage trait implementations in mdk-sqlite-storage"
          ]
        },
        {
          "id": "REQ-2.10",
          "title": "Enable WAL Mode",
          "description": "Configure SQLite to use WAL mode for better concurrent read performance.",
          "status": "pending",
          "acceptance_criteria": [
            "PRAGMA journal_mode=WAL executed on connection open",
            "WAL mode verified in tests",
            "Documentation notes WAL mode usage"
          ],
          "deliverables": [
            "Connection initialization code in lib.rs"
          ]
        }
      ]
    },
    {
      "id": "phase-3",
      "name": "Implement StorageProvider<1> for MdkMemoryStorage",
      "description": "Make MdkMemoryStorage directly implement the OpenMLS storage trait with unified in-memory data structures.",
      "status": "pending",
      "requirements": [
        {
          "id": "REQ-3.1",
          "title": "Remove openmls_memory_storage Dependency",
          "description": "Remove the external OpenMLS memory storage dependency.",
          "status": "pending",
          "acceptance_criteria": [
            "openmls_memory_storage removed from mdk-memory-storage/Cargo.toml",
            "openmls_memory_storage removed from workspace Cargo.toml if present",
            "No compilation errors after removal"
          ],
          "deliverables": [
            "Updated crates/mdk-memory-storage/Cargo.toml"
          ]
        },
        {
          "id": "REQ-3.2",
          "title": "Add MLS In-Memory Data Structures",
          "description": "Add HashMap-based storage for all MLS state types.",
          "status": "pending",
          "acceptance_criteria": [
            "mls_group_data: RwLock<HashMap<(Vec<u8>, GroupDataType), Vec<u8>>> added",
            "mls_proposals: RwLock<HashMap<(Vec<u8>, Vec<u8>), Vec<u8>>> added",
            "mls_key_packages: RwLock<HashMap<Vec<u8>, Vec<u8>>> added",
            "mls_psks: RwLock<HashMap<Vec<u8>, Vec<u8>>> added",
            "mls_signature_keys: RwLock<HashMap<Vec<u8>, Vec<u8>>> added",
            "mls_encryption_keys: RwLock<HashMap<Vec<u8>, Vec<u8>>> added",
            "mls_epoch_key_pairs: RwLock<HashMap<(Vec<u8>, Vec<u8>, u32), Vec<u8>>> added",
            "mls_own_leaf_nodes: RwLock<HashMap<Vec<u8>, Vec<Vec<u8>>>> added",
            "GroupDataType enum defined for polymorphic storage"
          ],
          "deliverables": [
            "Updated crates/mdk-memory-storage/src/lib.rs",
            "crates/mdk-memory-storage/src/mls_storage.rs"
          ]
        },
        {
          "id": "REQ-3.3",
          "title": "Implement StorageProvider Methods for Memory",
          "description": "Implement all 56 StorageProvider<1> methods for in-memory storage.",
          "status": "pending",
          "acceptance_criteria": [
            "All 18 write methods implemented",
            "All 19 read methods implemented",
            "All 19 delete methods implemented",
            "Methods use RwLock appropriately (read vs write locks)",
            "All methods tested"
          ],
          "deliverables": [
            "StorageProvider impl in crates/mdk-memory-storage/src/mls_storage.rs"
          ]
        },
        {
          "id": "REQ-3.4",
          "title": "Implement Snapshot/Rollback Support",
          "description": "Add snapshot capability for testing parity with SQLite savepoints.",
          "status": "pending",
          "acceptance_criteria": [
            "MemoryStorageSnapshot struct defined with cloned state from all HashMaps and LRU caches",
            "create_snapshot() method clones all internal state",
            "restore_snapshot(snapshot) method replaces all internal state",
            "Snapshot/restore cycle preserves data integrity",
            "Integration test demonstrates snapshot/rollback workflow"
          ],
          "deliverables": [
            "crates/mdk-memory-storage/src/snapshot.rs",
            "Snapshot methods in lib.rs"
          ]
        },
        {
          "id": "REQ-3.5",
          "title": "Update Existing MDK Storage Implementations",
          "description": "Ensure GroupStorage, MessageStorage, and WelcomeStorage implementations work with unified structure.",
          "status": "pending",
          "acceptance_criteria": [
            "GroupStorage impl uses unified data structures",
            "MessageStorage impl uses unified data structures",
            "WelcomeStorage impl uses unified data structures",
            "All existing MDK storage tests pass",
            "LRU caches still function correctly"
          ],
          "deliverables": [
            "Updated storage trait implementations in mdk-memory-storage"
          ]
        }
      ]
    },
    {
      "id": "phase-4",
      "name": "Update mdk-core",
      "description": "Update MdkProvider to work with the new trait bounds where storage IS the provider.",
      "status": "pending",
      "requirements": [
        {
          "id": "REQ-4.1",
          "title": "Update MdkProvider Implementation",
          "description": "Modify OpenMlsProvider impl for MdkProvider to return Storage directly instead of Storage::OpenMlsStorageProvider.",
          "status": "pending",
          "acceptance_criteria": [
            "OpenMlsProvider impl updated: type StorageProvider = Storage",
            "storage() method returns &self.storage directly",
            "Removed indirection through openmls_storage() accessor",
            "cargo check -p mdk-core succeeds"
          ],
          "deliverables": [
            "Updated crates/mdk-core/src/lib.rs"
          ]
        },
        {
          "id": "REQ-4.2",
          "title": "Update Any Direct Storage Access",
          "description": "Find and update any code that was using openmls_storage() or openmls_storage_mut() accessors.",
          "status": "pending",
          "acceptance_criteria": [
            "Grep for openmls_storage returns no results in mdk-core",
            "All direct OpenMLS storage access updated to use storage directly",
            "No compilation errors"
          ],
          "deliverables": [
            "Updated code in mdk-core that accessed OpenMLS storage"
          ]
        },
        {
          "id": "REQ-4.3",
          "title": "Remove Unused OpenMLS Storage Dependencies",
          "description": "Clean up workspace-level dependencies that are no longer needed.",
          "status": "pending",
          "acceptance_criteria": [
            "openmls_sqlite_storage removed from workspace Cargo.toml",
            "openmls_memory_storage removed from workspace Cargo.toml",
            "cargo build --all-features succeeds",
            "No unused dependency warnings"
          ],
          "deliverables": [
            "Updated Cargo.toml (workspace)"
          ]
        }
      ]
    },
    {
      "id": "phase-5",
      "name": "Testing and Validation",
      "description": "Ensure all existing tests pass and add new tests for unified storage functionality.",
      "status": "pending",
      "requirements": [
        {
          "id": "REQ-5.1",
          "title": "Port Existing Storage Tests",
          "description": "Ensure all existing storage tests pass with the new implementation.",
          "status": "pending",
          "acceptance_criteria": [
            "All mdk-sqlite-storage tests pass",
            "All mdk-memory-storage tests pass",
            "All mdk-core tests pass",
            "just test succeeds"
          ],
          "deliverables": [
            "Passing test suite"
          ]
        },
        {
          "id": "REQ-5.2",
          "title": "Add Transaction/Savepoint Tests",
          "description": "Add comprehensive tests for SQLite transaction and savepoint functionality.",
          "status": "pending",
          "acceptance_criteria": [
            "Test savepoint creation succeeds",
            "Test rollback to savepoint restores previous state",
            "Test release savepoint commits changes",
            "Test nested savepoints work correctly",
            "Test savepoint with MLS + MDK operations"
          ],
          "deliverables": [
            "Transaction tests in mdk-sqlite-storage"
          ]
        },
        {
          "id": "REQ-5.3",
          "title": "Add Cross-Storage Atomicity Tests",
          "description": "Test that MLS and MDK operations can be atomic within a single transaction.",
          "status": "pending",
          "acceptance_criteria": [
            "Test write MLS state + MDK state in single transaction",
            "Test rollback reverts both MLS and MDK state",
            "Test partial failure handling",
            "Test demonstrates fix for Issue #54 scenario"
          ],
          "deliverables": [
            "Atomicity tests in mdk-sqlite-storage and mdk-core"
          ]
        },
        {
          "id": "REQ-5.4",
          "title": "Add Migration Tests",
          "description": "Test that migration creates correct schema.",
          "status": "pending",
          "acceptance_criteria": [
            "Test fresh database has all expected tables",
            "Test all indexes exist",
            "Test foreign key constraints work",
            "Test schema matches plan specification"
          ],
          "deliverables": [
            "Migration tests in mdk-sqlite-storage"
          ]
        },
        {
          "id": "REQ-5.5",
          "title": "Add Snapshot/Rollback Tests for Memory Storage",
          "description": "Test snapshot and rollback functionality in memory storage.",
          "status": "pending",
          "acceptance_criteria": [
            "Test create_snapshot captures all state",
            "Test restore_snapshot restores all state",
            "Test snapshot doesn't affect live storage until restore",
            "Test multiple snapshots work independently"
          ],
          "deliverables": [
            "Snapshot tests in mdk-memory-storage"
          ]
        },
        {
          "id": "REQ-5.6",
          "title": "Run Full Test Suite",
          "description": "Run complete test suite and precommit checks.",
          "status": "pending",
          "acceptance_criteria": [
            "just test-all passes",
            "just precommit passes",
            "No test coverage decrease",
            "All clippy warnings addressed"
          ],
          "deliverables": [
            "Clean CI run"
          ]
        }
      ]
    }
  ],
  "cross_cutting_concerns": [
    {
      "id": "CC-1",
      "title": "Breaking Change Communication",
      "description": "This is a breaking change with no migration path from the old architecture.",
      "requirements": [
        "CHANGELOG entries for all affected crates (mdk-storage-traits, mdk-sqlite-storage, mdk-memory-storage, mdk-core)",
        "Breaking changes section clearly documents removed APIs",
        "README updated to reflect new architecture"
      ]
    },
    {
      "id": "CC-2",
      "title": "Test Coverage",
      "description": "Maintain or improve test coverage throughout implementation.",
      "requirements": [
        "No decrease in test coverage (CI enforced)",
        "New StorageProvider methods all have tests",
        "Transaction/savepoint functionality tested"
      ]
    },
    {
      "id": "CC-3",
      "title": "Documentation",
      "description": "Update documentation to reflect new architecture.",
      "requirements": [
        "Rustdoc updated for changed public APIs",
        "Architecture diagrams updated if present",
        "Migration notes for downstream users"
      ]
    },
    {
      "id": "CC-4",
      "title": "Version Pinning",
      "description": "Ensure OpenMLS dependencies are properly pinned.",
      "requirements": [
        "openmls_traits pinned to 0.4.1",
        "openmls pinned to 0.7.1",
        "Document version compatibility requirements"
      ]
    }
  ],
  "success_metrics": {
    "functionality": [
      "Single transaction can wrap MLS + MDK operations",
      "Savepoint-based rollback works correctly",
      "All 56 StorageProvider methods implemented and tested"
    ],
    "architecture": [
      "Single connection per storage instance",
      "No dual-connection pattern remains",
      "openmls_sqlite_storage dependency removed",
      "openmls_memory_storage dependency removed"
    ],
    "quality": [
      "All existing tests pass",
      "Test coverage maintained or improved",
      "just precommit passes",
      "No clippy warnings"
    ]
  },
  "risks": [
    {
      "risk": "OpenMLS StorageProvider trait changes",
      "impact": "Medium",
      "mitigation": "Pin to openmls_traits = 0.4.1, test against specific version"
    },
    {
      "risk": "Serialization compatibility",
      "impact": "Low",
      "mitigation": "Keep same JSON codec as openmls_sqlite_storage"
    },
    {
      "risk": "Test coverage drop",
      "impact": "Medium",
      "mitigation": "Port all existing storage tests, add new unified tests"
    },
    {
      "risk": "Performance regression",
      "impact": "Low",
      "mitigation": "Profile before/after; single connection should be faster"
    }
  ],
  "future_work": [
    {
      "title": "Commit Race Resolution (Issue #54)",
      "description": "Use savepoints to snapshot state before applying commits, rollback if a better commit arrives"
    },
    {
      "title": "Pending Commit Buffering (Issue #25)",
      "description": "Store incoming commits temporarily, apply the winner after a short delay"
    },
    {
      "title": "State Snapshots",
      "description": "Longer-term rollback capability if needed"
    }
  ]
}
