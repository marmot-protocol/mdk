# MDK C Bindings

C ABI bindings for the [Marmot Development Kit](https://github.com/marmot-protocol/mdk) — bringing decentralized, encrypted group messaging to any language that can call C.

## What is MDK?

MDK combines [MLS (Messaging Layer Security)](https://www.rfc-editor.org/rfc/rfc9420.html) with [Nostr](https://github.com/nostr-protocol/nostr) for real end-to-end encrypted group messaging. Forward secrecy, post-compromise security, automatic key rotation, metadata protection — the works. No server required.

These C bindings expose the full MDK API as `extern "C"` functions, suitable for embedding in C/C++ applications or as a base for FFI in other languages (Go, Zig, JS, etc.).

## Installation

### Prebuilt Libraries

Download the latest release from [mdk-cbindings releases](https://github.com/marmot-protocol/mdk-cbindings/releases) (this repo is auto-populated by CI on first publish):

```
include/mdk.h                   # C header (generated by cbindgen)
lib/linux-x86_64/libmdk.so      # Linux
lib/macos-aarch64/libmdk.dylib   # macOS
lib/windows-x86_64/mdk.dll       # Windows
```

### Build from Source

```bash
git clone https://github.com/marmot-protocol/mdk.git
cd mdk
cargo build --release -p mdk-cbindings
# Output: target/release/libmdk.{so,dylib,dll}
# Header: crates/mdk-cbindings/include/mdk.h
```

## Quick Start

```c
#include "mdk.h"
#include <stdio.h>

int main(void) {
    struct MdkHandle *mdk = NULL;

    // Create an unencrypted instance (dev/testing only!)
    enum MdkError err = mdk_new_unencrypted("/tmp/mdk-test.db", NULL, &mdk);
    if (err != MDK_ERROR_OK) {
        char *msg = mdk_last_error_message();
        fprintf(stderr, "Failed to create MDK: %s\n", msg);
        mdk_string_free(msg);
        return 1;
    }

    // Get all groups
    char *groups_json = NULL;
    err = mdk_get_groups(mdk, &groups_json);
    if (err != MDK_ERROR_OK) {
        char *msg = mdk_last_error_message();
        fprintf(stderr, "Failed to get groups: %s\n", msg);
        mdk_string_free(msg);
        mdk_free(mdk);
        return 1;
    }

    printf("Groups: %s\n", groups_json);
    mdk_string_free(groups_json);

    mdk_free(mdk);
    return 0;
}
```

Compile:

```bash
gcc -o example example.c -L./lib/linux-x86_64 -lmdk -I./include
```

## API Overview

### Lifecycle

| Function | Description |
|----------|-------------|
| `mdk_new` | Create with encrypted storage (platform keyring) |
| `mdk_new_with_key` | Create with a directly provided 32-byte key |
| `mdk_new_unencrypted` | Create with unencrypted storage (dev only) |
| `mdk_free` | Free the handle |

### Error Handling

Every fallible function returns `MdkError`. On failure, call `mdk_last_error_message()` to get a detailed error string (thread-local, consumed on read).

```c
enum MdkError err = mdk_get_groups(mdk, &out);
if (err != MDK_ERROR_OK) {
    char *msg = mdk_last_error_message();
    fprintf(stderr, "Error: %s\n", msg);
    mdk_string_free(msg);
}
```

Error codes:

| Code | Meaning |
|------|---------|
| `MDK_ERROR_OK` | Success |
| `MDK_ERROR_STORAGE` | SQLite / I/O error |
| `MDK_ERROR_MDK` | MLS / protocol / crypto error |
| `MDK_ERROR_INVALID_INPUT` | Bad hex, JSON, byte length, etc. |
| `MDK_ERROR_NULL_POINTER` | A required pointer was null |

### Memory Management

Strings and byte arrays returned by `mdk_*` functions are heap-allocated by Rust. **You must free them**:

```c
mdk_string_free(str);           // for char* returns
mdk_bytes_free(data, len);      // for uint8_t* + len returns
```

Passing `NULL` to either is a safe no-op.

### Key Packages

| Function | Description |
|----------|-------------|
| `mdk_create_key_package` | Create a key package for a Nostr event |
| `mdk_create_key_package_with_options` | Same, with NIP-70 protected tag option |
| `mdk_parse_key_package` | Parse and validate a key package event |

### Groups

| Function | Description |
|----------|-------------|
| `mdk_get_groups` | Get all groups (JSON array) |
| `mdk_get_group` | Get a single group by MLS group ID |
| `mdk_get_members` | Get group members (hex pubkey array) |
| `mdk_create_group` | Create a new group |
| `mdk_add_members` | Add members via key package events |
| `mdk_remove_members` | Remove members by pubkey |
| `mdk_update_group_data` | Update name, description, relays, admins |
| `mdk_self_update` | Key rotation |
| `mdk_leave_group` | Leave a group |
| `mdk_merge_pending_commit` | Merge a pending MLS commit |
| `mdk_clear_pending_commit` | Rollback a pending commit |
| `mdk_sync_group_metadata` | Sync metadata from MLS state |
| `mdk_get_relays` | Get relays for a group |
| `mdk_groups_needing_self_update` | Find groups needing key rotation |

### Messages

| Function | Description |
|----------|-------------|
| `mdk_create_message` | Create an encrypted message |
| `mdk_process_message` | Process an incoming MLS message |
| `mdk_get_messages` | Get messages with pagination |
| `mdk_get_message` | Get a single message by event ID |
| `mdk_get_last_message` | Get the most recent message |

### Welcomes

| Function | Description |
|----------|-------------|
| `mdk_get_pending_welcomes` | Get pending welcome invites |
| `mdk_get_welcome` | Get a welcome by event ID |
| `mdk_process_welcome` | Process an incoming welcome |
| `mdk_accept_welcome` | Accept a welcome (join group) |
| `mdk_decline_welcome` | Decline a welcome |

### Media (Free Functions)

| Function | Description |
|----------|-------------|
| `mdk_prepare_group_image` | Encrypt an image for upload |
| `mdk_decrypt_group_image` | Decrypt a group image |
| `mdk_derive_upload_keypair` | Derive upload keypair from image key |

## Data Format

Complex types are serialised as **JSON strings** across the FFI boundary. The C header uses opaque `MdkHandle*` for the main instance. Simple scalars (error codes, lengths, booleans) stay as scalars.

## Thread Safety

All `extern "C"` functions are panic-safe (wrapped in `catch_unwind`). The `MdkHandle` contains an internal mutex, so it is safe to call from multiple threads — but avoid concurrent calls on the same handle for best performance.

## Further Reading

- [Marmot Protocol Spec](https://github.com/marmot-protocol/marmot)
- [MLS RFC 9420](https://www.rfc-editor.org/rfc/rfc9420.html)
- [Nostr Protocol](https://github.com/nostr-protocol/nostr)
